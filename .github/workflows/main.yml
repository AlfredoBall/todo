name: Main Deployment Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  terraform:
    name: Provision Infrastructure
    uses: ./.github/workflows/terraform.yml
    with:
      target_env: 'development'
    secrets: inherit
    permissions:
      id-token: write
      contents: read

  build:
    name: Build Applications
    needs: terraform
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      target_env: 'development'
      api_url: ${{ needs.terraform.outputs.api_url }}
      angular_url: ${{ needs.terraform.outputs.frontend_url }}/todo/angular
      react_url: ${{ needs.terraform.outputs.frontend_url }}/todo/react
      frontend_client_id: ${{ needs.terraform.outputs.frontend_client_id }}
      api_client_id: ${{ needs.terraform.outputs.api_client_id }}
      api_scope_uri: ${{ needs.terraform.outputs.api_scope_uri }}
  deploy:
    name: Deploy Applications
    needs: [terraform, build]
    uses: ./.github/workflows/deploy.yml
    secrets: inherit
    permissions:
      id-token: write
      contents: read
    with:
      target_env: 'development'
      api_url: ${{ needs.terraform.outputs.api_url }}